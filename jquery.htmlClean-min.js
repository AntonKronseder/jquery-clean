(function(D){D.fn.htmlClean=function(Z){return this.each(function(){var a=D(this);if(this.value){this.value=D.htmlClean(this.value,Z)}else{this.innerHTML=D.htmlClean(this.innerHTML,Z)}})};D.htmlClean=function(d,o){o=jQuery.extend(D.htmlClean.defaults,o);var g=/<(\/)?(\w+:)?([\w]+)([^>]*)>/gi;var k=/(\w+)=(".*?"|'.*?'|[^\s>]*?)/gi;var f;var h=new S();var j=[h];var Z=h;if(o.bodyOnly){if(f=/<body[^>]*>((\n|.)*)<\/body>/i.exec(d)){d=f[1]}}while(f=g.exec(d)){var n=new H(f[3],f[1],f[4]);var l=RegExp.leftContext.substring(e);if(l.length>0){var b=Z.children[Z.children.length-1];if(Z.children.length>0&&O(b=Z.children[Z.children.length-1])){Z.children[Z.children.length-1]=b.concat(l)}else{Z.children.push(l)}}var e=g.lastIndex;if(n.isClosing){if(I(j,[n.name])){j.pop();Z=j[j.length-1]}}else{var c=new S(n);if(!n.toIgnore){if(n.allowedAttributes!=null){var a;while(a=k.exec(n.rawAttributes)){if(n.allowedAttributes.length==0||D.inArray(a[1],n.allowedAttributes)>-1){c.attributes.push(new A(a[1],a[2]))}}}var m=true;if(!Z.isRoot){if(Z.tag.isInline&&!n.isInline){m=false}else{if(Z.tag.disallowNest&&n.disallowNest&&!n.requiredParent){m=false}else{if(n.requiredParent){if(m=I(j,n.requiredParent)){Z=j[j.length-1]}}}}}if(m){Z.children.push(c);if(!n.isSelfClosing&&!n.isNonClosing){j.push(c);Z=c}}}}}return Y(h,o).join("")};D.htmlClean.defaults={bodyOnly:true,removeAttrs:[],allowedClasses:[],format:false,formatIndent:0};function G(c,b,a,Z){if(!c.tag.isInline&&a.length>0){a.push("\n");for(i=0;i<Z;i++){a.push("\t")}}}function Y(c,h){var a=[],f=c.attributes.length==0,b;for(var d=0;d<N.length;d++){if(N[d][0]==c.tag.name){if(N[d].length==1||N[d][1].test(c.tag.rawAttributes)){c.tag.name=V[d]}}}if(!c.isRoot){a.push("<");a.push(c.tag.name);D.each(c.attributes,function(){if(D.inArray(this.name,h.removeAttrs)==-1){var j=RegExp(/^(['"]?)(.*?)['"]?$/).exec(this.value);var k=j[2];var l=j[1];if(this.name=="class"){k=D.grep(k.split(" "),function(m){return D.inArray(m,h.allowedClasses)>-1}).join(" ");l='"'}if(k!=null&&k.length>0){a.push(" ");a.push(this.name);a.push("=");a.push(l);a.push(k);a.push(l)}}})}if(c.tag.isSelfClosing){a.push(" />");f=false}else{if(c.tag.isNonClosing){f=false}else{if(!c.isRoot){a.push(">")}var b=h.formatIndent++;var e=[];for(var d=0;d<c.children.length;d++){var Z=c.children[d];var g=D.htmlClean.trim(C(Z.toString()));if(R(Z)){if(d>0&&g.length>0&&(X(Z)||F(c.children[d-1]))){e.push(" ")}}if(O(Z)){if(g.length>0){e.push(g)}}else{if(d!=c.children.length-1||Z.tag.name!="br"){if(h.format){G(Z,h,e,b)}e=e.concat(Y(Z,h))}}}h.formatIndent--;if(e.length>0){if(h.format&&e[0]!="\n"){G(c,h,a,b)}a=a.concat(e);f=false}if(!c.isRoot){if(h.format){G(c,h,a,b-1)}a.push("</");a.push(c.tag.name);a.push(">")}}}if(!c.tag.allowEmpty&&f){return[]}return a}function I(Z,b,a){a=a||1;if(D.inArray(Z[Z.length-a].tag.name,b)>-1){return true}else{if(Z.length-(a+1)>0&&I(Z,b,a+1)){Z.pop();return true}}return false}function S(Z){if(Z){this.tag=Z;this.isRoot=false}else{this.tag=new H("root");this.isRoot=true}this.attributes=[];this.children=[];this.toString=function(){return this.children.join("")};return this}function A(Z,a){this.name=Z;this.value=a;return this}function H(Z,b,a){this.name=Z.toLowerCase();this.isSelfClosing=D.inArray(this.name,K)>-1;this.isNonClosing=D.inArray(this.name,T)>-1;this.isClosing=(b!=undefined&&b.length>0);this.isInline=D.inArray(this.name,U)>-1;this.disallowNest=D.inArray(this.name,Q)>-1;this.requiredParent=E[D.inArray(this.name,E)+1];this.allowEmpty=D.inArray(this.name,B)>-1;this.toIgnore=D.inArray(this.name,J)>-1;this.rawAttributes=a;this.allowedAttributes=L[D.inArray(this.name,L)+1];return this}function X(Z){while(P(Z)&&Z.children.length>0){Z=Z.children[0]}return O(Z)&&Z.length>0&&D.htmlClean.isWhitespace(Z.charAt(0))}function F(Z){while(P(Z)&&Z.children.length>0){Z=Z.children[Z.children.length-1]}return O(Z)&&Z.length>0&&D.htmlClean.isWhitespace(Z.charAt(Z.length-1))}function O(Z){return Z.constructor==String}function R(Z){return O(Z)||Z.tag.isInline}function P(Z){return Z.constructor==S}function C(Z){return Z.replace(/&nbsp;|\n/g," ").replace(/\s\s+/g," ")}D.htmlClean.trim=function(Z){return D.htmlClean.trimStart(D.htmlClean.trimEnd(Z))};D.htmlClean.trimStart=function(Z){return Z.substring(D.htmlClean.trimStartIndex(Z))};D.htmlClean.trimStartIndex=function(Z){for(var a=0;a<Z.length-1&&D.htmlClean.isWhitespace(Z.charAt(a));a++){}return a};D.htmlClean.trimEnd=function(Z){return Z.substring(0,D.htmlClean.trimEndIndex(Z))};D.htmlClean.trimEndIndex=function(a){for(var Z=a.length-1;Z>=0&&D.htmlClean.isWhitespace(a.charAt(Z));Z--){}return Z+1};D.htmlClean.isWhitespace=function(Z){return D.inArray(Z,W)!=-1};var J=["basefont","center","dir","font","frame","frameset","iframe","isindex","menu","noframes","s","strike","u"];var N=[["b"],["big"],["span",/weight:\s*bold/i],["i"],["span",/style:\s*italic/i],["span",/-align:\s*super/i],["span",/-align:\s*sub/i]];var V=["strong","strong","strong","em","em","sup","sub"];var U=["a","abbr","acronym","address","b","big","br","button","caption","cite","code","del","em","font","hr","i","input","img","ins","label","legend","map","q","samp","select","small","span","strong","sub","sup","tt","var"];var Q=["h1","h2","h3","h4","h5","h6","p","th","td"];var B=["th","td"];var E=[null,"li",["ul","ol"],"dt",["dl"],"dd",["dl"],"td",["tr"],"th",["tr"],"tr",["table","thead","tbody","tfoot"],"thead",["table"],"tbody",["table"],"tfoot",["table"]];var M=["script","style","pre","code"];var K=["br","hr","img","link","meta"];var T=["!doctype","?xml"];var L=[["class"],"?xml",[],"!doctype",[],"a",["accesskey","class","href","name","title","rel","rev","type","tabindex"],"abbr",["class","title"],"acronym",["class","title"],"blockquote",["cite","class"],"button",["class","disabled","name","type","value"],"del",["cite","class","datetime"],"form",["accept","action","class","enctype","method","name"],"input",["accept","accesskey","alt","checked","class","disabled","ismap","maxlength","name","size","readonly","src","tabindex","type","usemap","value"],"img",["alt","class","height","src","width"],"ins",["cite","class","datetime"],"label",["accesskey","class","for"],"legend",["accesskey","class"],"link",["href","rel","type"],"meta",["content","http-equiv","name","scheme"],"map",["name"],"optgroup",["class","disabled","label"],"option",["class","disabled","label","selected","value"],"q",["class","cite"],"script",["src","type"],"select",["class","disabled","multiple","name","size","tabindex"],"style",["type"],"table",["class","summary"],"textarea",["accesskey","class","cols","disabled","name","readonly","rows","tabindex"]];var W=[" "," ","\t","\n","\r","\f"]})(jQuery);